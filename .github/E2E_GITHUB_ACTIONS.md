# E2E Tests on GitHub Actions

This document explains how E2E tests are configured to run automatically on GitHub Actions.

## Overview

E2E tests run automatically on every push and pull request to `main` and `develop` branches. Tests are parallelized across 4 shards for faster execution.

## Workflows

### 1. CI Workflow (`.github/workflows/ci.yml`)

Runs on every push/PR and includes:

- **Lint & Type Check**: ESLint and TypeScript validation
- **Unit Tests**: Jest test suite with coverage reports
- **Build**: Next.js production build verification
- **Trigger E2E**: Automatically triggers E2E workflow if all checks pass

### 2. E2E Tests Workflow (`.github/workflows/e2e-tests.yml`)

Runs E2E tests in parallel with the following features:

- **Test Sharding**: Splits tests across 4 parallel jobs (customizable)
- **PostgreSQL Service**: Temporary database for each test run
- **Playwright**: Browser automation with Chromium
- **Artifacts**: Test reports and failure screenshots/videos
- **Report Merging**: Combines results from all shards

## Configuration

### Environment Variables

E2E tests use these environment variables (automatically set in CI):

```bash
DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_timetable
AUTH_SECRET=<auto-generated>
AUTH_GOOGLE_ID=dummy-client-id
AUTH_GOOGLE_SECRET=dummy-client-secret
ENABLE_DEV_BYPASS=true
NEXT_PUBLIC_ENABLE_DEV_BYPASS=true
SEED_FOR_TESTS=true
SEED_CLEAN_DATA=true
NEXT_TELEMETRY_DISABLED=1
CI=true
```

### Test Sharding

By default, tests run across 4 parallel jobs. You can customize this:

1. Go to **Actions** tab on GitHub
2. Select **E2E Tests** workflow
3. Click **Run workflow**
4. Choose shard count (1, 2, 4, or 8)

## Running E2E Tests

### Automatic Triggers

E2E tests run automatically when:

- Code is pushed to `main` or `develop`
- Pull request is created/updated targeting `main` or `develop`
- CI workflow completes successfully (optional trigger)

### Manual Trigger

You can manually trigger E2E tests:

1. Go to **Actions** tab
2. Select **E2E Tests** workflow
3. Click **Run workflow**
4. Select branch and shard count
5. Click **Run workflow** button

## Viewing Results

### Test Reports

After tests complete:

1. Go to the workflow run page
2. Scroll to **Artifacts** section
3. Download:
   - `playwright-report-merged` - Combined HTML report from all shards
   - `playwright-report-shard-X` - Individual shard reports
   - `test-results-shard-X` - Failure screenshots/videos (only if tests failed)

### Inline Results

Test results are also visible:

- ✅ Check marks show passing tests
- ❌ X marks show failing tests
- Click on a job to see detailed logs

## Test Database

Each test run uses a temporary PostgreSQL database:

- **Version**: PostgreSQL 16
- **Credentials**: `test_user` / `test_password`
- **Database**: `test_timetable`
- **Lifecycle**: Created at job start, destroyed at job end
- **Seeding**: Automatically seeded with MOE-compliant test data

## Authentication

Tests use **Dev Bypass** authentication:

- No real OAuth credentials needed
- Instant authentication as mock admin user
- Only enabled when `ENABLE_DEV_BYPASS=true`
- Automatically configured in CI environment

## Performance

Current metrics:

- **Total Tests**: ~579 test cases
- **Shard Count**: 4 parallel jobs
- **Average Runtime**: ~15-20 minutes per shard
- **Total Wall Time**: ~15-20 minutes (parallelized)

## Troubleshooting

### Tests Timing Out

If tests timeout:

1. Check test logs for hanging operations
2. Increase timeout in `playwright.config.ts`
3. Use fewer shards for better resource allocation

### Database Connection Errors

If database connections fail:

1. Check PostgreSQL service health in workflow logs
2. Verify `DATABASE_URL` format
3. Ensure migrations ran successfully

### Auth Setup Failures

If auth setup fails:

1. Verify `ENABLE_DEV_BYPASS=true` is set
2. Check that `NEXT_PUBLIC_ENABLE_DEV_BYPASS=true` is set
3. Look for semester-storage timeout errors

### Flaky Tests

If tests are flaky:

1. Check retry configuration (`retries: 2` in CI)
2. Review test-specific timeouts
3. Use `waitForLoadState` instead of fixed delays
4. Add proper locator assertions before actions

## Optimizing CI Time

### Reducing Test Time

1. **Increase Shards**: Use 8 shards instead of 4
   - Faster execution but higher resource usage
2. **Skip Visual Tests**: Comment out visual inspection tests
   - Reduces total test count by ~10-15%

3. **Parallel Workers**: Already optimized (4 workers per shard)
   - Can't increase much more without resource contention

### Reducing CI Runs

1. **Skip CI**: Add `[skip ci]` to commit message

   ```bash
   git commit -m "docs: update README [skip ci]"
   ```

2. **Path Filters**: Add path filters to workflows (advanced)
   ```yaml
   on:
     push:
       paths:
         - "src/**"
         - "e2e/**"
   ```

## Cost Optimization

GitHub Actions is free for public repositories and includes:

- 2,000 minutes/month for private repos on Free plan
- Unlimited minutes for public repos

To optimize usage:

- Use larger shards for fewer but longer jobs
- Cache dependencies aggressively (already done)
- Only run E2E on important branches

## Best Practices

1. **Always Review Reports**: Download and review HTML reports for failures
2. **Fix Flaky Tests**: Don't ignore intermittent failures
3. **Update Regularly**: Keep Playwright and browsers updated
4. **Monitor Duration**: Track test execution time trends
5. **Use Artifacts**: Leverage screenshots/videos for debugging

## Related Documentation

- [Playwright Configuration](../playwright.config.ts)
- [E2E Test Guide](../e2e/README.md)
- [GitHub Actions Docs](https://docs.github.com/en/actions)
- [Playwright Best Practices](https://playwright.dev/docs/best-practices)
