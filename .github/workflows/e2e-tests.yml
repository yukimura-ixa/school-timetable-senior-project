# .github/workflows/e2e-tests.yml
name: E2E Tests

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "screenshots/**"
      - "LICENSE"
      - ".gitignore"
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: "Update Playwright visual baselines"
        required: false
        default: "false"
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DATABASE_URL: postgresql://test_user:test_password@localhost:5433/test_timetable
  BETTER_AUTH_URL: http://localhost:3005
  BASE_URL: http://localhost:3005
  AUTO_MANAGE_TEST_DB: "false"
  NEXT_TELEMETRY_DISABLED: "1"

jobs:
  test:
    name: E2E (${{ matrix.shard }})
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      actions: read

    strategy:
      fail-fast: false
      matrix:
        shard: [sequential, parallel]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_timetable
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U test_user -d test_timetable"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: pnpm

      - name: Setup env files
        run: |
          cat > .env.test << 'ENVEOF'
          DATABASE_URL=postgresql://test_user:test_password@localhost:5433/test_timetable
          BETTER_AUTH_SECRET=${{ secrets.BETTER_AUTH_SECRET }}
          BETTER_AUTH_URL=http://localhost:3005
          BASE_URL=http://localhost:3005
          AUTH_GOOGLE_ID=dummy-client-id
          AUTH_GOOGLE_SECRET=dummy-client-secret
          SEED_SECRET=${{ secrets.SEED_SECRET }}
          SEED_FOR_TESTS=true
          SEED_CLEAN_DATA=true
          NEXT_TELEMETRY_DISABLED=1
          NODE_ENV=test
          CI=true
          ENVEOF
          cp .env.test .env.test.local
          cp .env.test .env.local
          cp .env.test .env.production

      - name: Install & generate
        run: |
          pnpm install --frozen-lockfile
          pnpm prisma generate

      - name: Migrate & seed
        run: |
          pnpm prisma migrate deploy
          pnpm db:seed:clean
        env:
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          SEED_FOR_TESTS: "true"
          SEED_CLEAN_DATA: "true"

      - name: Verify database seed
        run: pnpm exec tsx scripts/verify-test-db.ts

      # --- Build: try reusing CI artifact, fallback to own build ---
      - name: Download CI build artifact
        id: download-build
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: ci.yml
          commit: ${{ github.sha }}
          name: build-output
          path: .
          check_artifacts: true
          search_artifacts: true
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Check for .next directory
        id: check-build
        run: |
          if [ -d ".next" ] && [ -f ".next/BUILD_ID" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "âœ… CI build artifact found, skipping build"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "âš ï¸ No CI build artifact, will build locally"
          fi

      - name: Cache Next.js build & Prisma
        if: steps.check-build.outputs.found == 'false'
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
            node_modules/.prisma
          key: ${{ runner.os }}-e2e-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('prisma/schema.prisma') }}
          restore-keys: ${{ runner.os }}-e2e-

      - name: Build (fallback)
        if: steps.check-build.outputs.found == 'false'
        run: pnpm build
        env:
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          AUTH_GOOGLE_ID: dummy-client-id
          AUTH_GOOGLE_SECRET: dummy-client-secret
          SEED_FOR_TESTS: "true"
          NODE_ENV: production

      # --- Playwright setup ---
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: pw-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.pw-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright deps (cached)
        if: steps.pw-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium

      # --- Compute test file list for this shard ---
      - name: Compute shard test files
        id: shard
        run: |
          SEQ_FILE="e2e/shard-sequential.list"
          # Read sequential list (skip comments and blank lines)
          SEQ_PATTERNS=$(grep -v '^#' "$SEQ_FILE" | grep -v '^\s*$' | sed 's|^|e2e/|' | tr '\n' ' ')

          if [ "${{ matrix.shard }}" = "sequential" ]; then
            echo "files=$SEQ_PATTERNS" >> "$GITHUB_OUTPUT"
            echo "workers=1" >> "$GITHUB_OUTPUT"
            echo "retries=2" >> "$GITHUB_OUTPUT"
            echo "ðŸ“‹ Sequential shard: $(echo $SEQ_PATTERNS | wc -w) test files"
          else
            # Parallel shard: find all spec files NOT in the sequential list
            ALL_FILES=$(find e2e -name '*.spec.ts' -not -path '*/prod/*' | sort)
            PARALLEL_FILES=""
            for f in $ALL_FILES; do
              MATCH=false
              while IFS= read -r line; do
                # Skip comments and blank lines
                [[ "$line" =~ ^#.*$ ]] && continue
                [[ -z "$line" ]] && continue
                if [ "$f" = "e2e/$line" ]; then
                  MATCH=true
                  break
                fi
              done < "$SEQ_FILE"
              if [ "$MATCH" = "false" ]; then
                PARALLEL_FILES="$PARALLEL_FILES $f"
              fi
            done
            echo "files=$PARALLEL_FILES" >> "$GITHUB_OUTPUT"
            echo "workers=3" >> "$GITHUB_OUTPUT"
            echo "retries=1" >> "$GITHUB_OUTPUT"
            echo "ðŸ“‹ Parallel shard: $(echo $PARALLEL_FILES | wc -w) test files"
          fi

      # --- Run tests ---
      - name: Run E2E tests (${{ matrix.shard }})
        run: |
          EXTRA_ARGS=""
          if [ "${{ inputs.update_snapshots }}" = "true" ]; then
            EXTRA_ARGS="--update-snapshots"
          fi
          pnpm exec playwright test \
            --timeout=90000 \
            --workers=${{ steps.shard.outputs.workers }} \
            --retries=${{ steps.shard.outputs.retries }} \
            $EXTRA_ARGS \
            ${{ steps.shard.outputs.files }}
        env:
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          AUTH_GOOGLE_ID: dummy-client-id
          AUTH_GOOGLE_SECRET: dummy-client-secret
          CI: "true"
          SKIP_DB_SEED: "true"

      - name: Server logs (on failure)
        if: failure()
        run: |
          if [ -f server.log ]; then tail -200 server.log; else echo "No server.log"; fi

      # --- Upload artifacts (shard-specific names) ---
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ matrix.shard }}
          path: |
            test-results/
            artifacts/
          retention-days: 14

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 14

      - name: Upload JUnit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-junit-${{ matrix.shard }}
          path: test-results/**/*.xml
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload updated snapshots
        if: always() && inputs.update_snapshots == true && matrix.shard == 'parallel'
        uses: actions/upload-artifact@v4
        with:
          name: updated-snapshots
          path: |
            e2e/**/*-snapshots/*.png
            e2e/visual/**/*.png
          retention-days: 30
          if-no-files-found: warn

  # --- Merge results from both shards ---
  merge-results:
    name: Merge E2E Results
    runs-on: ubuntu-latest
    if: always()
    needs: [test]
    timeout-minutes: 5
    steps:
      - name: Download all JUnit results
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-junit-*
          merge-multiple: true
          path: test-results
        continue-on-error: true

      - name: Upload merged JUnit
        uses: actions/upload-artifact@v4
        with:
          name: playwright-junit
          path: test-results/**/*.xml
          retention-days: 14
          if-no-files-found: ignore

      - name: Download all HTML reports
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-html-report-*
          path: playwright-reports
        continue-on-error: true

      - name: Upload merged HTML reports
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-reports-combined
          path: playwright-reports/
          retention-days: 14
          if-no-files-found: ignore
