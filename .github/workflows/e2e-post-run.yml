# .github/workflows/e2e-post-run.yml
# Merged workflow: Combines e2e-failure-issue.yml and e2e-test-report.yml
# Triggered after E2E Tests workflow completes
name: E2E Post-Run

on:
  workflow_run:
    workflows: ["E2E Tests"]
    types: [completed]
    branches: [main, develop]

permissions:
  contents: read
  issues: write
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  # Job 1: Publish JUnit test reports (always runs)
  publish-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Playwright JUnit artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-junit
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: test-results
        continue-on-error: true

      - name: Detect JUnit files
        id: junit
        run: |
          shopt -s nullglob
          # Check multiple possible paths
          files=(test-results/*.xml test-results/**/*.xml)
          if [ ${#files[@]} -eq 0 ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "No JUnit files downloaded; skipping report"
          else
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "JUnit files:" "${files[@]}"
          fi

      - name: Publish Playwright E2E test check
        if: steps.junit.outputs.found == 'true'
        uses: dorny/test-reporter@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Playwright E2E
          reporter: java-junit
          path: test-results/**/*.xml

  # Job 2: Create GitHub issue on failure (only on failure)
  create-failure-issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check for existing open issue
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-failure,automated'
            });

            // Check if there's already an open issue for recent failures
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const now = new Date();
              const hoursSinceCreation = (now - createdAt) / (1000 * 60 * 60);
              return hoursSinceCreation < 24; // Only consider issues from last 24 hours
            });

            if (recentIssue) {
              console.log(`Found existing issue #${recentIssue.number}, will add comment instead`);
              core.setOutput('existing_issue', recentIssue.number);
              return;
            }

            core.setOutput('existing_issue', '');

      - name: Get workflow run details
        id: run-details
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            const failedJobNames = failedJobs.map(job => `- ${job.name}`).join('\n');

            core.setOutput('run_url', run.data.html_url);
            core.setOutput('commit_sha', run.data.head_sha.substring(0, 7));
            core.setOutput('branch', run.data.head_branch);
            core.setOutput('failed_jobs', failedJobNames || '- Unknown');
            core.setOutput('run_id', run.data.id);

      - name: Create failure issue
        if: steps.check-issue.outputs.existing_issue == ''
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ steps.run-details.outputs.run_url }}
          COMMIT_SHA: ${{ steps.run-details.outputs.commit_sha }}
          BRANCH: ${{ steps.run-details.outputs.branch }}
          FAILED_JOBS: ${{ steps.run-details.outputs.failed_jobs }}
          RUN_ID: ${{ steps.run-details.outputs.run_id }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const { RUN_URL, COMMIT_SHA, BRANCH, FAILED_JOBS, RUN_ID, WORKFLOW_RUN_ID } = process.env;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üî¥ E2E Test Failure - ${today}`,
              body: `## E2E Test Failure Report

            **Workflow Run:** [${WORKFLOW_RUN_ID}](${RUN_URL})
            **Branch:** \`${BRANCH}\`
            **Commit:** \`${COMMIT_SHA}\`
            **Status:** Failed ‚ùå

            ### Failed Jobs
            ${FAILED_JOBS}

            ### Quick Debug Steps

            1. **Download artifacts:**
               \`\`\`powershell
               # Using GitHub CLI (recommended)
               pnpm ci:artifacts

               # Or specify run ID
               .\\scripts\\download-e2e-artifacts.ps1 -RunId ${RUN_ID}
               \`\`\`

            2. **View HTML report:**
               \`\`\`bash
               pnpm test:report
               \`\`\`

            3. **View trace files:**
               \`\`\`bash
               pnpm exec playwright show-trace test-results-ci/**/*.zip
               \`\`\`

            4. **Reproduce locally (CI mode):**
               \`\`\`bash
               pnpm test:e2e:ci-mode
               \`\`\`

            ### Artifacts
            - [Download artifacts](${RUN_URL}#artifacts)

            ---
            *This issue was automatically created by the E2E Post-Run workflow.*
            *Close this issue once the failure is resolved.*`,
              labels: ['e2e-failure', 'automated', 'bug']
            });

            console.log(`Created issue #${issue.data.number}`);

      - name: Add comment to existing issue
        if: steps.check-issue.outputs.existing_issue != ''
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ steps.run-details.outputs.run_url }}
          COMMIT_SHA: ${{ steps.run-details.outputs.commit_sha }}
          BRANCH: ${{ steps.run-details.outputs.branch }}
          FAILED_JOBS: ${{ steps.run-details.outputs.failed_jobs }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
          EXISTING_ISSUE: ${{ steps.check-issue.outputs.existing_issue }}
        with:
          script: |
            const { RUN_URL, COMMIT_SHA, BRANCH, FAILED_JOBS, WORKFLOW_RUN_ID, EXISTING_ISSUE } = process.env;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(EXISTING_ISSUE),
              body: `## Additional E2E Failure

            **Workflow Run:** [${WORKFLOW_RUN_ID}](${RUN_URL})
            **Branch:** \`${BRANCH}\`
            **Commit:** \`${COMMIT_SHA}\`

            ### Failed Jobs
            ${FAILED_JOBS}

            [View run details](${RUN_URL})`
            });

            console.log(`Added comment to issue #${EXISTING_ISSUE}`);
