# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "screenshots/**"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "screenshots/**"
      - "LICENSE"
      - ".gitignore"

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache Prisma Client
        uses: actions/cache@v4
        with:
          path: node_modules/.prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('prisma/schema.prisma') }}
          restore-keys: |
            ${{ runner.os }}-prisma-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-prisma-

      - name: Cache TypeScript Build Info
        uses: actions/cache@v4
        with:
          path: |
            **/.tsbuildinfo
            **/*.tsbuildinfo
          key: ${{ runner.os }}-tsbuildinfo-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-tsbuildinfo-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Run targeted ESLint
        run: pnpm exec eslint --ext .ts,.tsx src/features/*/domain src/features/*/application src/features/*/infrastructure

      - name: Run TypeScript type check
        run: pnpm typecheck

  # TEMPORARILY DISABLED: Jest crashes in CI with Next.js 16 compatibility issues
  # See: https://github.com/yukimura-ixa/school-timetable-senior-project/issues/141
  # Re-enable after Jest + Next.js 16 memory issues are resolved
  # unit-tests:
  #   name: Unit Tests
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15
  #
  #   env:
  #     DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
  #
  #   services:
  #     postgres:
  #       image: postgres:16
  #       env:
  #         POSTGRES_USER: dummy
  #         POSTGRES_PASSWORD: dummy
  #         POSTGRES_DB: dummy
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup pnpm
  #       uses: pnpm/action-setup@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "20"
  #         cache: "pnpm"
  #
  #     - name: Cache Prisma Client
  #       uses: actions/cache@v4
  #       with:
  #         path: node_modules/.prisma
  #         key: ${{ runner.os }}-prisma-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('prisma/schema.prisma') }}
  #         restore-keys: |
  #           ${{ runner.os }}-prisma-${{ hashFiles('**/pnpm-lock.yaml') }}-
  #           ${{ runner.os }}-prisma-
  #
  #     - name: Cache Jest
  #       uses: actions/cache@v4
  #       with:
  #         path: |
  #           .jest-cache
  #           coverage
  #         key: ${{ runner.os }}-jest-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.test.ts', '**/*.test.tsx') }}
  #         restore-keys: |
  #           ${{ runner.os }}-jest-${{ hashFiles('**/pnpm-lock.yaml') }}-
  #           ${{ runner.os }}-jest-
  #
  #     - name: Install dependencies
  #       run: pnpm install --frozen-lockfile
  #
  #     - name: Generate Prisma Client
  #       run: pnpm prisma generate
  #
  #     - name: Run Jest unit tests
  #       # Lightweight unit/regression suites only.
  #       # Heavy teaching-assignment + Playwright flows run in .github/workflows/e2e-tests.yml.
  #       run: pnpm test
  #       env:
  #         NODE_ENV: test
  #         NODE_OPTIONS: --max_old_space_size=4096
  #
  #     - name: Upload coverage reports
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: coverage-report
  #         path: coverage/
  #         retention-days: 30

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
      AUTH_SECRET: build-time-secret
      AUTH_GOOGLE_ID: dummy-client-id
      AUTH_GOOGLE_SECRET: dummy-client-secret
      NEXT_TELEMETRY_DISABLED: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache Prisma Client
        uses: actions/cache@v4
        with:
          path: node_modules/.prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('prisma/schema.prisma') }}
          restore-keys: |
            ${{ runner.os }}-prisma-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-prisma-

      - name: Cache Next.js Build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Build Next.js application
        run: pnpm build

  # Trigger E2E tests only if all other checks pass
  trigger-e2e:
    name: Trigger E2E Tests
    needs: [lint, build] # unit-tests temporarily disabled
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Trigger E2E workflow
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'e2e-tests.yml',
              ref: context.ref
            })
