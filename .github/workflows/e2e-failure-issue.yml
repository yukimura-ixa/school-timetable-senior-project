# .github/workflows/e2e-failure-issue.yml
# Automatically creates GitHub issues when E2E tests fail
name: E2E Failure Issue Creator

on:
  workflow_run:
    workflows: ["E2E Tests"]
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  create-issue:
    # Only run when E2E Tests workflow fails
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for existing open issue
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2e-failure,automated'
            });
            
            // Check if there's already an open issue for recent failures
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const now = new Date();
              const hoursSinceCreation = (now - createdAt) / (1000 * 60 * 60);
              return hoursSinceCreation < 24; // Only consider issues from last 24 hours
            });
            
            if (recentIssue) {
              console.log(`Found existing issue #${recentIssue.number}, will add comment instead`);
              core.setOutput('existing_issue', recentIssue.number);
              return;
            }
            
            core.setOutput('existing_issue', '');

      - name: Get workflow run details
        id: run-details
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });
            
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            const failedJobNames = failedJobs.map(job => `- ${job.name}`).join('\n');
            
            core.setOutput('run_url', run.data.html_url);
            core.setOutput('commit_sha', run.data.head_sha.substring(0, 7));
            core.setOutput('branch', run.data.head_branch);
            core.setOutput('failed_jobs', failedJobNames || '- Unknown');
            core.setOutput('run_id', run.data.id);

      - name: Create failure issue
        if: steps.check-issue.outputs.existing_issue == ''
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üî¥ E2E Test Failure - ${today}`,
              body: `## E2E Test Failure Report
            
            **Workflow Run:** [${{ github.event.workflow_run.id }}](${{ steps.run-details.outputs.run_url }})
            **Branch:** \`${{ steps.run-details.outputs.branch }}\`
            **Commit:** \`${{ steps.run-details.outputs.commit_sha }}\`
            **Status:** Failed ‚ùå
            
            ### Failed Jobs
            ${{ steps.run-details.outputs.failed_jobs }}
            
            ### Quick Debug Steps
            
            1. **Download artifacts:**
               \`\`\`powershell
               # Using GitHub CLI (recommended)
               pnpm ci:artifacts
               
               # Or specify run ID
               .\\scripts\\download-e2e-artifacts.ps1 -RunId ${{ steps.run-details.outputs.run_id }}
               \`\`\`
            
            2. **View HTML report:**
               \`\`\`bash
               pnpm test:report
               \`\`\`
            
            3. **View trace files:**
               \`\`\`bash
               pnpm exec playwright show-trace test-results-ci/**/*.zip
               \`\`\`
            
            4. **Reproduce locally (CI mode):**
               \`\`\`bash
               pnpm test:e2e:ci-mode
               \`\`\`
            
            ### Artifacts
            - [Download artifacts](${{ steps.run-details.outputs.run_url }}#artifacts)
            
            ---
            *This issue was automatically created by the E2E Failure Issue Creator workflow.*
            *Close this issue once the failure is resolved.*`,
              labels: ['e2e-failure', 'automated', 'bug']
            });
            
            console.log(`Created issue #${issue.data.number}`);

      - name: Add comment to existing issue
        if: steps.check-issue.outputs.existing_issue != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.check-issue.outputs.existing_issue }},
              body: `## Additional E2E Failure
            
            **Workflow Run:** [${{ github.event.workflow_run.id }}](${{ steps.run-details.outputs.run_url }})
            **Branch:** \`${{ steps.run-details.outputs.branch }}\`
            **Commit:** \`${{ steps.run-details.outputs.commit_sha }}\`
            
            ### Failed Jobs
            ${{ steps.run-details.outputs.failed_jobs }}
            
            [View run details](${{ steps.run-details.outputs.run_url }})`
            });
            
            console.log(`Added comment to issue #${{ steps.check-issue.outputs.existing_issue }}`);
