name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation,
# and allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      # Clone the repository to install dependencies and MCP servers
      contents: read

    # You can define any steps you want, and they will run before the agent starts.
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      # Install pnpm package manager
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # Install Python for Python-based MCP servers (Serena, MarkItDown)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Install project dependencies (includes next-devtools-mcp from package.json)
      - name: Install project dependencies
        run: pnpm install --frozen-lockfile

      # ============================================================================
      # Install MCP servers to match .vscode/mcp.json configuration
      # ============================================================================

      # 1. Context7 MCP (upstash/context7) - HTTP-based, no installation needed
      - name: Setup Context7 MCP
        run: |
          echo "‚úì Context7 MCP configured (HTTP-based)"
          echo "  Server: upstash/context7"
          echo "  URL: https://mcp.context7.com/mcp"
          echo "  Purpose: Library documentation (Next.js, React, Prisma, MUI, etc.)"

      # 2. Playwright MCP (microsoft/playwright-mcp) - stdio via npx
      - name: Install Playwright MCP
        run: |
          echo "Installing Playwright MCP for browser automation..."
          npx -y @playwright/mcp@latest --version || echo "Playwright MCP will be available via npx"
        continue-on-error: true

      # 3. MarkItDown MCP (microsoft/markitdown) - stdio via uvx/pip
      - name: Install MarkItDown MCP
        run: |
          echo "Installing MarkItDown MCP for document conversion..."
          pip install markitdown-mcp==0.0.1a4
        continue-on-error: true

      # 4. Serena MCP (oraios/serena) - stdio via uvx/pip
      - name: Install Serena MCP
        run: |
          echo "Installing Serena MCP for symbol-aware code navigation..."
          pip install git+https://github.com/oraios/serena
        continue-on-error: true

      # 5. MUI MCP (mui-mcp) - stdio via npx
      - name: Install MUI MCP
        run: |
          echo "Installing MUI MCP for Material-UI documentation..."
          npx -y @mui/mcp@latest --version || echo "MUI MCP will be available via npx"
        continue-on-error: true

      # 6. GitHub MCP (github/github-mcp-server) - HTTP-based, no installation needed
      - name: Setup GitHub MCP
        run: |
          echo "‚úì GitHub MCP configured (HTTP-based)"
          echo "  Server: github/github-mcp-server"
          echo "  URL: https://api.githubcopilot.com/mcp/"
          echo "  Purpose: Issues/PR context & summaries"

      # 7. Next DevTools MCP (next-devtools) - stdio via npx (already in package.json)
      - name: Verify Next DevTools MCP
        run: |
          echo "‚úì Next DevTools MCP available from package.json"
          echo "  Package: next-devtools-mcp@^0.2.1"
          echo "  Purpose: Next.js 16 diagnostics & codemods"
          test -d node_modules/next-devtools-mcp && echo "  Status: Installed" || echo "  Status: Will install on demand"

      # 8. Prisma MCP (prisma-postgres) - HTTP-based, no installation needed
      - name: Setup Prisma MCP
        run: |
          echo "‚úì Prisma MCP configured (HTTP-based)"
          echo "  Server: prisma-postgres"
          echo "  URL: https://mcp.prisma.io/mcp"
          echo "  Purpose: Schema reasoning & migrations"

      # 9. Vercel MCP - HTTP-based, no installation needed
      - name: Setup Vercel MCP
        run: |
          echo "‚úì Vercel MCP configured (HTTP-based)"
          echo "  URL: https://mcp.vercel.com"
          echo "  Purpose: Vercel deployment context"

      # Generate Prisma Client for database operations
      - name: Generate Prisma Client
        run: pnpm prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://test:test@localhost:5432/test' }}
        continue-on-error: true

      # Verify installations
      - name: Verify Environment
        run: |
          echo "========================================"
          echo "Environment Verification"
          echo "========================================"
          echo "Node.js: $(node --version)"
          echo "NPM: $(npm --version)"
          echo "PNPM: $(pnpm --version)"
          echo "Python: $(python --version)"
          echo "Pip: $(pip --version)"
          echo ""
          echo "Python packages:"
          pip list | grep -E "(markitdown|serena)" || echo "  (Python MCP packages listed above)"
          echo ""
          echo "Next DevTools MCP: $(test -d node_modules/next-devtools-mcp && echo 'Installed' || echo 'Available on demand')"
        continue-on-error: true

      # Summary
      - name: Setup Summary
        run: |
          echo "========================================"
          echo "‚úÖ Copilot Environment Setup Complete!"
          echo "========================================"
          echo ""
          echo "üì¶ MCP Servers Configured (from .vscode/mcp.json):"
          echo ""
          echo "HTTP-Based (No Installation Required):"
          echo "  ‚úì Context7 (upstash/context7) - Library docs"
          echo "  ‚úì GitHub (github/github-mcp-server) - Issues/PR context"
          echo "  ‚úì Prisma (prisma-postgres) - Schema & migrations"
          echo "  ‚úì Vercel - Deployment context"
          echo ""
          echo "Stdio-Based (Installed):"
          echo "  ‚úì Playwright (@playwright/mcp) - Browser automation"
          echo "  ‚úì MarkItDown (markitdown-mcp) - Document conversion"
          echo "  ‚úì Serena (oraios/serena) - Symbol-aware navigation"
          echo "  ‚úì MUI (@mui/mcp) - Material-UI docs"
          echo "  ‚úì Next DevTools (next-devtools-mcp) - Next.js 16 diagnostics"
          echo ""
          echo "üéØ Copilot can now use all 9 MCP servers for enhanced context!"
          echo "üìù Configuration: .vscode/mcp.json"
          echo ""
