# .github/workflows/smoke-tests.yml
name: Smoke Tests

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "screenshots/**"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "screenshots/**"
      - "LICENSE"
      - ".gitignore"
  workflow_dispatch:

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    permissions:
      contents: read
      pull-requests: write
      checks: write

    env:
      DATABASE_URL: postgresql://test_user:test_password@localhost:5433/test_timetable
      AUTO_MANAGE_TEST_DB: "false"

    # PostgreSQL service container
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_timetable
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U test_user -d test_timetable"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup environment variables
        run: |
          cat > .env.test << EOF
          DATABASE_URL=postgresql://test_user:test_password@localhost:5433/test_timetable
          AUTH_SECRET=ci-test-secret-$(openssl rand -hex 16)
          AUTH_GOOGLE_ID=dummy-client-id
          AUTH_GOOGLE_SECRET=dummy-client-secret
          SEED_FOR_TESTS=true
          SEED_CLEAN_DATA=true
          NEXT_TELEMETRY_DISABLED=1
          NODE_ENV=test
          CI=true
          EOF
          cp .env.test .env.local
          cp .env.test .env.production
          echo "âœ… Environment files configured"

      - name: Validate environment configuration
        run: |
          echo "ğŸ” Validating .env.test configuration..."
          if [ -f .env.test ]; then
            echo "âœ… .env.test exists"
            if grep -q "DATABASE_URL" .env.test; then
              echo "âœ… DATABASE_URL is set"
            else
              echo "âŒ DATABASE_URL is missing"
              exit 1
            fi
            if grep -q "AUTH_SECRET" .env.test; then
              echo "âœ… AUTH_SECRET is set"
            else
              echo "âŒ AUTH_SECRET is missing"
              exit 1
            fi
            echo "âœ… All required environment variables are configured"
          else
            echo "âŒ .env.test not found"
            exit 1
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Apply database migrations
        run: pnpm prisma migrate deploy

      - name: Seed test database
        run: pnpm db:seed:clean
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5433/test_timetable
          SEED_FOR_TESTS: "true"
          SEED_CLEAN_DATA: "true"

      - name: Build Next.js application
        run: pnpm build
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5433/test_timetable
          AUTH_SECRET: ci-test-build-secret
          AUTH_GOOGLE_ID: dummy-client-id
          AUTH_GOOGLE_SECRET: dummy-client-secret
          SEED_FOR_TESTS: "true"
          SEED_CLEAN_DATA: "true"
          NEXT_TELEMETRY_DISABLED: "1"
          NODE_ENV: production

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run smoke tests
        run: pnpm test:smoke
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5433/test_timetable
          NEXT_TELEMETRY_DISABLED: "1"
          CI: "true"
          AUTO_MANAGE_TEST_DB: "false"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 14

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'test-results/results.json';

            let comment = '## ğŸ§ª Smoke Test Results\n\n';

            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              const stats = results.stats || {};
              
              if (stats.expected === stats.total) {
                comment += 'âœ… All smoke tests passed!\n\n';
              } else {
                comment += 'âŒ Some smoke tests failed\n\n';
              }
              
              comment += `- **Total Tests**: ${stats.total || 0}\n`;
              comment += `- **Passed**: ${stats.expected || 0}\n`;
              comment += `- **Failed**: ${(stats.unexpected || 0) + (stats.flaky || 0)}\n`;
              comment += `- **Skipped**: ${stats.skipped || 0}\n`;
              comment += `- **Duration**: ${((stats.duration || 0) / 1000 / 60).toFixed(2)} minutes\n`;
            } else {
              comment += 'âš ï¸ Test results not found\n';
            }

            comment += '\n[View detailed results in workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# Fast smoke test workflow - runs on every PR
# Provides quick feedback (~10-15 minutes) on critical functionality
# Full E2E tests run only on main branch (see e2e-tests.yml)
