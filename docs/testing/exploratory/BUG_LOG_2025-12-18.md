# Bug Log – 2025-12-18

Consolidated report with evidence bundle:
- `docs/testing/exploratory/PROD_ADMIN_BUG_BASH_REPORT_2025-12-18.md`

## P1 / Major – Dashboard throws React error #418 after successful login
- **Severity:** P1 (stability)  
- **Impact:** Runtime console error on authenticated dashboard; may indicate hydration/markup mismatch and hides other errors; could break future components.  
- **Environment:** https://phrasongsa-timetable.vercel.app/dashboard (Chromium via Playwright MCP) on 2025-12-18, role: admin.  
- **Steps to Reproduce:**  
  1. Login as admin (`admin@school.local` / `admin123`).  
  2. Observe browser console upon landing on `/dashboard`.  
- **Expected:** No console errors; dashboard renders cleanly.  
- **Actual:** Console logs `Minified React error #418 ... HTML` immediately after navigation.  
- **Evidence:** Playwright console capture during session (MCP 2025-12-18).  
- **Suspected Area:** Dashboard layout hydration / Next.js React 19 markup mismatch.

## P0 / Critical – Timetable times render in UTC (timezone shift)
- **Severity:** P0 (data correctness / operational risk)  
- **Impact:** Timetable shows period times like `01:30–02:20` instead of expected local morning times (e.g., `08:30–09:20`), undermining trust and risking real-world scheduling mistakes.  
- **Environment:** Production, admin session, semester `1-2567` on 2025-12-18.  
- **Steps to Reproduce:**  
  1. Go to `/schedule/1-2567/arrange`.  
  2. Select a teacher (example: `TeacherID=620`).  
  3. Observe the “เวลา” row.  
  4. Repeat on `/dashboard/1-2567/teacher-table` after selecting a teacher.  
- **Expected:** Time row reflects Thai local time (Asia/Bangkok), starting around the configured school start time.  
- **Actual:** Time row starts at ~`01:30` (UTC-like offset).  
- **Evidence:**  
  - `docs/testing/exploratory/artifacts/bugbash-2025-12-18/arrange-teacher-time-row.png`  
  - `docs/testing/exploratory/artifacts/bugbash-2025-12-18/dashboard-teacher-table-time-row.png`  

## P1 / Major – Semester-scoped dashboard sidebar links drop semester context
- **Severity:** P1 (workflow blocker / UX)  
- **Impact:** From `/dashboard/1-2567`, clicking sidebar navigation sends user to `/dashboard` (semester picker) instead of staying under the selected semester.  
- **Environment:** Production, admin session, semester `1-2567` on 2025-12-18.  
- **Steps to Reproduce:**  
  1. Open `/dashboard/1-2567`.  
  2. Click sidebar “แสดงตารางรวมครู”.  
  3. Observe URL becomes `/dashboard`.  
- **Expected:** `/dashboard/1-2567/all-timeslot`.  
- **Actual:** `/dashboard`.  
- **Evidence:**  
  - `docs/testing/exploratory/artifacts/bugbash-2025-12-18/dashboard-1-2567-overview.png`  
  - `docs/testing/exploratory/artifacts/bugbash-2025-12-18/sidebar-link-loses-semester.png`  

## P1 / Major – Student table grade selector labels malformed and selection triggers 500s
- **Severity:** P1 (functional)  
- **Impact:** Admin cannot reliably view student timetables; dropdown includes invalid labels (e.g., `ม.1/0`, `ม.7/-1`) and selecting can trigger server 500 responses.  
- **Environment:** Production, admin session, semester `1-2567` on 2025-12-18.  
- **Steps to Reproduce:**  
  1. Open `/dashboard/1-2567/student-table`.  
  2. Open class dropdown and observe labels like `ม.1/0`, `ม.7/-1`.  
  3. Select an option (example: `ม.1/0`) and observe console errors “Failed to load resource: 500”.  
- **Expected:** Valid class labels (e.g., `ม.1/1`, `ม.1/2`) and no 500s.  
- **Actual:** Malformed labels and repeated 500 responses.  
- **Evidence:**  
  - `docs/testing/exploratory/artifacts/bugbash-2025-12-18/student-table-grade-dropdown-broken.png`  
  - `docs/testing/exploratory/artifacts/bugbash-2025-12-18/student-table-time-row-and-500.png`  

## P1 / Major – Teacher table intermittently shows “ไม่สามารถโหลดข้อมูลคาบเรียนได้”
- **Severity:** P1 (reliability)  
- **Impact:** Key dashboard view intermittently fails to load; admin can’t verify teacher schedules.  
- **Environment:** Production, admin session, semester `1-2567` on 2025-12-18.  
- **Steps to Reproduce:**  
  1. Navigate to `/dashboard/1-2567/teacher-table`.  
  2. Observe intermittent banner “เกิดข้อผิดพลาด: ไม่สามารถโหลดข้อมูลคาบเรียนได้”.  
- **Expected:** No error banner; page loads normally.  
- **Actual:** Error banner appears intermittently; console also shows hydration error #418.  
- **Evidence:**  
  - `docs/testing/exploratory/artifacts/bugbash-2025-12-18/dashboard-teacher-table-error.png`  

## P1 / Major – Logout button returns 403 and does not end session
- **Severity:** P1 (auth/session)  
- **Impact:** Admin cannot log out; session persists, potential security/privacy risk on shared devices.  
- **Environment:** https://phrasongsa-timetable.vercel.app/ (header logout) on 2025-12-18, role: admin.  
- **Steps to Reproduce:**  
  1. Login as admin.  
  2. Click the header “ออกจากระบบ” button.  
  3. Attempt to navigate to `/signin`.  
- **Expected:** Session cleared, redirected to `/signin`, no access to dashboard without re-login.  
- **Actual:** Console shows 403; stays on /management. Navigating to `/signin` bounces back to `/dashboard`, session still active.  
- **Evidence:** Playwright run (MCP 2025-12-18) showing 403 on logout request and redirect back to dashboard.  
- **Suspected Area:** Auth.js signOut handler / route protection middleware.

## P2 / Minor – Login form lacks `<form>` container (console warning)
- **Severity:** P2 (usability/accessibility)  
- **Impact:** Possible accessibility/autofill issues; console noise during auth; may block form-level validation or Enter-key submit on some browsers.  
- **Environment:** https://phrasongsa-timetable.vercel.app/signin (Chromium via Playwright MCP) on 2025-12-18, role: unauthenticated.  
- **Steps to Reproduce:**  
  1. Navigate to `/signin`.  
  2. Open browser console.  
  3. Enter any email/password.  
  4. Click “เข้าสู่ระบบ”.  
- **Expected:** Form submits without console errors; inputs wrapped in a `<form>` element to support native submission and accessibility.  
- **Actual:** Console logs `Password field is not contained in a form` and login still sends request.  
- **Evidence:** Playwright console log captured during run (MCP session 2025-12-18).  
- **Suspected Area:** `src/app/signin` page / SignInForm component markup.

## P1 / Major – Cannot create grade level (DisplayID missing on server) ✅ FIXED
- **Severity:** P1 (functional)  
- **Impact:** Admins cannot add new classes/sections; backend rejects creation with Prisma error requiring `DisplayID`, blocking semester setup.  
- **Environment:** https://phrasongsa-timetable.vercel.app/management/gradelevel on 2025-12-18, role: admin.  
- **Steps to Reproduce:**  
  1. Go to Grade Level management.  
  2. Click "เพิ่ม", enter Year=1, Number=99, Program=M1-SCI, StudentCount=1.  
  3. Click save.  
- **Expected:** Grade created with code `M1-99`.  
- **Actual:** Error toast: "เพิ่มจัดการระดับชั้นไม่สำเร็จ … DisplayID is missing." No record created.  
- **Evidence:** Playwright attempt after repository fix; production build still returns Prisma validation error.  
- **Suspected Area:** Grade level server action still not setting `DisplayID` in deployed build (backend schema requires it).
- **Fix:** Removed DisplayID column from schema and all references (2025-12-18). Migration `20251218104559_remove_displayid_from_gradelevel` applied. DisplayID was redundant as it could be derived from GradeID or Year/Number.
- **Files Changed:**
  - `prisma/schema.prisma` - Removed DisplayID column from gradelevel model
  - `src/utils/grade-display.ts` - Updated to work with GradeID and year/section directly
  - `src/features/gradelevel/infrastructure/repositories/gradelevel.repository.ts` - Removed DisplayID from create/update operations
  - `prisma/seed.ts`, `prisma/seed-2568.ts` - Removed DisplayID from seed data
  - `src/features/teaching-assignment/presentation/components/AssignmentFilters.tsx` - Removed DisplayID from mock data
  - `src/app/(public)/classes/[gradeId]/[semesterAndyear]/page.tsx` - Updated to use only GradeID

